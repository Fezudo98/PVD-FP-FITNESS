{% extends "store/base.html" %}

{% block content %}
<section class="py-5 bg-white" style="min-height: 80vh;">
    <div class="container py-5">
        <h1 class="display-4 fw-bold text-dark mb-5 text-center" style="font-family: 'Outfit', sans-serif;">
            Finalizar <span class="text-warning">Compra</span>
        </h1>

        <div class="row g-5">
            <!-- Checkout Form -->
            <div class="col-lg-8">
                <div class="p-4 rounded-4 bg-light border border-light-subtle shadow-sm">
                    <h4 class="fw-bold text-dark mb-4" style="font-family: 'Outfit', sans-serif;">Seus Dados</h4>
                    <form id="checkoutForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nome" class="form-label text-muted small text-uppercase fw-bold">Nome
                                    Completo</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="nome" required style="padding: 0.75rem;">
                            </div>
                            <div class="col-md-6">
                                <label for="email"
                                    class="form-label text-muted small text-uppercase fw-bold">Email</label>
                                <input type="email" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="email" required style="padding: 0.75rem;">
                            </div>
                            <div class="col-md-6">
                                <label for="cpf" class="form-label text-muted small text-uppercase fw-bold">CPF</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="cpf" required style="padding: 0.75rem;" maxlength="14">
                                <div id="cpfFeedback" class="form-text mt-1" style="min-height: 1.5em;"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="telefone"
                                    class="form-label text-muted small text-uppercase fw-bold">Telefone</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="telefone" required style="padding: 0.75rem;" maxlength="15">
                                <div id="phoneFeedback" class="form-text mt-1" style="min-height: 1.5em;"></div>
                            </div>

                            <h5 class="fw-bold text-dark mt-4 mb-3" style="font-family: 'Outfit', sans-serif;">Endereço
                                de Entrega</h5>

                            <!-- CEP First -->
                            <div class="col-md-4">
                                <label for="cep" class="form-label text-muted small text-uppercase fw-bold">CEP</label>
                                <div class="input-group">
                                    <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                        id="cep" required style="padding: 0.75rem;" maxlength="9">
                                    <span class="input-group-text bg-white border-secondary-subtle text-muted">
                                        <i class="fa-solid fa-magnifying-glass"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-8"></div> <!-- Spacer to fill row -->

                            <div class="col-12">
                                <label for="rua" class="form-label text-muted small text-uppercase fw-bold">Rua</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="rua" required style="padding: 0.75rem;">
                            </div>
                            <div class="col-md-4">
                                <label for="numero"
                                    class="form-label text-muted small text-uppercase fw-bold">Número</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="numero" required style="padding: 0.75rem;">
                            </div>
                            <div class="col-md-8">
                                <label for="bairro"
                                    class="form-label text-muted small text-uppercase fw-bold">Bairro</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="bairro" required style="padding: 0.75rem;">
                            </div>
                            <div class="col-md-8">
                                <label for="cidade"
                                    class="form-label text-muted small text-uppercase fw-bold">Cidade</label>
                                <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                    id="cidade" required style="padding: 0.75rem;">
                            </div>
                            <div class="col-md-4">
                                <label for="estado" class="form-label text-muted small text-uppercase fw-bold">Estado
                                    (UF)</label>
                                <select class="form-select bg-white text-dark border-secondary-subtle" id="estado"
                                    required style="padding: 0.75rem;">
                                    <option value="">UF</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>

                            <div class="col-12 mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="salvarEndereco" checked>
                                    <label class="form-check-label text-muted small" for="salvarEndereco">
                                        Salvar este endereço como padrão para próximas compras
                                    </label>
                                </div>
                            </div>
                        </div>

                        <h5 class="fw-bold text-dark mt-4 mb-3" style="font-family: 'Outfit', sans-serif;">Pagamento
                        </h5>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="pagamento" id="cartao"
                                value="Cartão de Crédito" checked>
                            <label class="form-check-label text-dark" for="cartao">
                                Cartão de Crédito (Simulação)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="pagamento" id="pix" value="PIX">
                            <label class="form-check-label text-dark" for="pix">
                                PIX (Simulação)
                            </label>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="p-4 rounded-4 position-sticky bg-light border border-light-subtle shadow-sm"
                    style="top: 100px;">
                    <h4 class="fw-bold text-dark mb-4" style="font-family: 'Outfit', sans-serif;">Resumo</h4>
                    <ul class="list-group list-group-flush mb-3 bg-transparent" id="checkoutItems">
                        <!-- Items injected via JS -->
                    </ul>
                    <div class="d-flex justify-content-between mb-3 text-secondary">
                        <span>Subtotal</span>
                        <span id="checkoutSubtotal" class="text-dark fw-bold">R$ 0,00</span>
                    </div>
                    <!-- Shipping Options injected via JS -->
                    <div id="shippingOptions" class="mb-3 small border-bottom border-light-subtle pb-3"></div>

                    <div class="d-flex justify-content-between mb-3 text-secondary">
                        <span>Entrega</span>
                        <span id="checkoutShipping" class="text-dark fw-bold">---</span>
                    </div>

                    <!-- Coupon Input -->
                    <div class="mb-4">
                        <label for="cupomInput" class="form-label text-muted small text-uppercase fw-bold">Cupom de
                            Desconto</label>
                        <div class="input-group">
                            <input type="text" class="form-control bg-white text-dark border-secondary-subtle"
                                id="cupomInput" placeholder="Código" style="text-transform: uppercase;">
                            <button class="btn btn-outline-warning" type="button"
                                onclick="applyCoupon()">Aplicar</button>
                        </div>
                        <div id="cupomMessage" class="form-text mt-1"></div>
                    </div>

                    <!-- Discount Display (Hidden by default) -->
                    <div class="d-flex justify-content-between mb-3 text-success d-none" id="discountRow">
                        <span>Desconto</span>
                        <span id="checkoutDiscount" class="fw-bold">- R$ 0,00</span>
                    </div>

                    <hr class="my-4 border-secondary-subtle">
                    <div class="d-flex justify-content-between mb-4 align-items-center">
                        <span class="fw-bold text-dark h5 mb-0">Total</span>
                        <span class="fw-bold text-warning h4 mb-0" id="checkoutTotal">R$ 0,00</span>
                    </div>

                    <button onclick="submitOrder()"
                        class="btn btn-warning w-100 py-3 rounded-pill fw-bold shadow-sm text-uppercase"
                        style="letter-spacing: 1px; transition: all 0.3s ease;">
                        Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof renderCheckoutPage === 'function') {
            renderCheckoutPage();
        }

        // --- Input Masking Functions ---
        const formatCPF = (value) => {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .replace(/(-\d{2})\d+?$/, '$1');
        };

        const formatPhone = (value) => {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d)(\d{4})(\d{4})$/, '$1 $2-$3')
                .replace(/(-\d{4})\d+?$/, '$1');
        };

        const formatCEP = (value) => {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .replace(/(-\d{3})\d+?$/, '$1');
        };

        // Apply masks
        const cpfInput = document.getElementById('cpf');
        const phoneInput = document.getElementById('telefone');
        const cepInput = document.getElementById('cep');

        if (cpfInput) {
            cpfInput.addEventListener('input', (e) => {
                let val = e.target.value;
                e.target.value = formatCPF(val);

                // Real-time validation feedback
                const feedback = document.getElementById('cpfFeedback');
                if (feedback && typeof validateCPF === 'function') {
                    // Remove masc to validate
                    const cleanVal = val.replace(/\D/g, '');
                    if (cleanVal.length === 11) {
                        if (validateCPF(cleanVal)) {
                            feedback.textContent = 'CPF Válido';
                            feedback.className = 'form-text mt-1 text-success fw-bold';
                            cpfInput.classList.remove('is-invalid');
                            cpfInput.classList.add('is-valid');
                        } else {
                            feedback.textContent = 'CPF Inválido';
                            feedback.className = 'form-text mt-1 text-danger fw-bold';
                            cpfInput.classList.remove('is-valid');
                            cpfInput.classList.add('is-invalid');
                        }
                    } else {
                        feedback.textContent = '';
                        cpfInput.classList.remove('is-valid', 'is-invalid');
                    }
                }
            });
        }
        if (phoneInput) {
            phoneInput.addEventListener('input', (e) => {
                e.target.value = formatPhone(e.target.value);
            });
        }
        if (cepInput) {
            cepInput.addEventListener('input', (e) => {
                let value = e.target.value;
                e.target.value = formatCEP(value);

                const cleanCep = value.replace(/\D/g, '');
                if (cleanCep.length === 8) {
                    buscarCep(cleanCep);
                }
            });
        }
    });

    async function buscarCep(cep) {
        try {
            // 1. ViaCEP Lookup
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            if (!data.erro) {
                document.getElementById('rua').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('estado').value = data.uf;

                // 2. Calculate Shipping
                calculateShipping(cep);
            }
        } catch (e) {
            console.error('Erro ao buscar CEP:', e);
        }
    }

    async function calculateShipping(cep) {
        const cart = JSON.parse(localStorage.getItem('fp_fitness_cart')) || [];
        if (cart.length === 0) return;

        const container = document.getElementById('shippingOptions');
        if (container) container.innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div> Calculando frete...';

        try {
            const res = await fetch('/api/public/frete/calcular', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cep: cep, items: cart })
            });
            const options = await res.json();

            renderShippingOptions(options);

        } catch (e) {
            console.error('Erro ao calcular frete:', e);
            if (container) container.innerHTML = '<span class="text-danger">Erro ao calcular frete.</span>';
        }
    }

    function renderShippingOptions(options) {
        const container = document.getElementById('shippingOptions');
        if (!container) return;

        if (options.length === 0) {
            container.innerHTML = '<span class="text-danger">Nenhuma opção de entrega disponível para este CEP.</span>';
            return;
        }

        container.innerHTML = options.map((opt, index) => `
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="shippingOption" id="ship_${opt.id}" 
                    value="${opt.valor}" data-name="${opt.nome}" 
                    ${index === 0 ? 'checked' : ''} onchange="updateShippingCost(${opt.valor})">
                <label class="form-check-label d-flex justify-content-between w-100 pe-3" for="ship_${opt.id}">
                    <span>${opt.nome} (${opt.prazo})</span>
                    <span class="fw-bold">R$ ${opt.valor.toFixed(2)}</span>
                </label>
            </div>
        `).join('');

        // Apply first option by default
        if (options.length > 0) {
            updateShippingCost(options[0].valor);
        }
    }

    function updateShippingCost(cost) {
        window.shippingCost = cost;
        document.getElementById('checkoutShipping').textContent = `R$ ${cost.toFixed(2)}`;

        // Trigger generic total update (assuming functionality exists or likely needs to be added here)
        // Since store.js handles logic, we need to ensure it sees this cost.
        // We'll dispatch a custom event or call a global function if it exists.
        // Or simply recalculate here if simple.

        recalculateTotal();
    }

    function recalculateTotal() {
        const cart = JSON.parse(localStorage.getItem('fp_fitness_cart')) || [];
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        let discount = 0;
        // Check if global discount variable exists from store.js logic
        // Assuming store.js might expose appliedCoupon or we read UI text?
        // Let's try to read the discount text
        const discountText = document.getElementById('checkoutDiscount').textContent.replace(/[^\d.,]/g, '').replace(',', '.');
        discount = parseFloat(discountText) || 0;

        const shipping = window.shippingCost || 0;
        const total = subtotal - discount + shipping;

        // Update UI
        document.getElementById('checkoutSubtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
        document.getElementById('checkoutTotal').textContent = `R$ ${total.toFixed(2)}`;
    }
</script>
{% endblock %}