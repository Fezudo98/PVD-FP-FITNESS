{% extends "store/base.html" %}

{% block content %}
<section class="py-5 bg-light" style="min-height: 80vh;">
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-dark mb-3">Nossos Produtos</h1>
            <p class="text-muted lead">Confira nossa coleção completa.</p>
        </div>
        <div class="row mb-4">
            <div class="col-md-8 mx-auto">
                <div class="input-group">
                    <select class="form-select bg-white text-dark border-secondary" id="categoryFilter"
                        onchange="filterByCategory()" style="max-width: 200px;">
                        <option value="">Todas as Categorias</option>
                        <!-- Categories will be loaded here -->
                    </select>
                    <input type="text" class="form-control bg-white text-dark border-secondary"
                        placeholder="Buscar produtos..." id="searchInput">
                    <button class="btn btn-warning" type="button" onclick="searchProducts()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="row g-4" id="productsContainer">
            <!-- Products will be loaded here via JS -->
            <div class="col-12 text-center">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>
        </div>

        <!-- Pagination (Simplified) -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <button class="btn btn-outline-dark rounded-pill px-4" id="loadMoreBtn" onclick="loadMore()"
                    style="display: none;">Carregar Mais</button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentSearch = '';
    let currentCategory = '';

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    const debouncedSearch = debounce(() => searchProducts(), 300);

    document.addEventListener('DOMContentLoaded', function () {
        loadProducts();

        // Search on enter
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchProducts();
        });

        // Instant search with debounce
        document.getElementById('searchInput').addEventListener('input', function (e) {
            debouncedSearch();
        });
    });

    function searchProducts() {
        currentSearch = document.getElementById('searchInput').value;
        currentPage = 1;
        resetContainer();
        loadProducts();
    }

    function filterByCategory() {
        currentCategory = document.getElementById('categoryFilter').value;
        currentPage = 1;
        resetContainer();
        loadProducts();
    }

    function resetContainer() {
        document.getElementById('productsContainer').innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-warning" role="status"></div></div>';
    }

    async function loadProducts() {
        try {
            let url = `/api/store/products?page=${currentPage}&per_page=12`;
            if (currentSearch) url += `&q=${encodeURIComponent(currentSearch)}`;
            if (currentCategory) url += `&categoria=${encodeURIComponent(currentCategory)}`;

            const response = await fetch(url);
            const data = await response.json();
            const container = document.getElementById('productsContainer');

            if (currentPage === 1) container.innerHTML = '';

            // Update Categories Dropdown (only on first load to avoid resetting selection)
            const categorySelect = document.getElementById('categoryFilter');
            if (categorySelect.options.length <= 1 && data.categorias) {
                data.categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            }

            if (data.produtos && data.produtos.length > 0) {
                const html = data.produtos.map(p => `
                    <div class="col-md-6 col-lg-3">
                        <div class="product-card h-100 position-relative"> <!-- Added position-relative to fix stretched-link bug -->
                            <div class="product-img-wrapper position-relative">
                                <span class="badge badge-gold position-absolute top-0 end-0 m-3 px-3 py-2 rounded-pill z-2">
                                    R$ ${p.preco_venda.toFixed(2)}
                                </span>
                                <a href="/store/produto/${p.id}">
                                    <img src="${p.imagem_url ? '/uploads/' + p.imagem_url : 'https://via.placeholder.com/300x400?text=Sem+Imagem'}" alt="${p.nome}" class="img-fluid">
                                </a>
                            </div>
                            <div class="card-body p-4">
                                <div class="text-muted small mb-2 text-uppercase">${p.categoria || 'Geral'}</div>
                                <h5 class="card-title fw-bold mb-3">
                                    <a href="/store/produto/${p.id}" class="text-dark text-decoration-none stretched-link">${p.nome}</a>
                                </h5>
                                <button class="btn btn-outline-warning w-100 rounded-pill position-relative z-2" onclick="addToCart(${p.id}, '${p.nome}', ${p.preco_venda}, '${p.imagem_url || ''}')">
                                    <i class="fa-solid fa-cart-plus me-2"></i>Adicionar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.insertAdjacentHTML('beforeend', html);

                // Handle Load More button
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (data.pagina_atual < data.total_paginas) {
                    loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                if (currentPage === 1) {
                    container.innerHTML = '<div class="col-12 text-center text-muted"><p>Nenhum produto encontrado.</p></div>';
                }
                document.getElementById('loadMoreBtn').style.display = 'none';
            }
        } catch (error) {
            console.error('Erro ao carregar produtos:', error);
            if (currentPage === 1) {
                document.getElementById('productsContainer').innerHTML = '<div class="col-12 text-center text-danger"><p>Erro ao carregar produtos.</p></div>';
            }
        }
    }

    function loadMore() {
        currentPage++;
        loadProducts();
    }
</script>
{% endblock %}