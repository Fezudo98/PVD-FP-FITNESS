{% extends "store/base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row g-5">
        <!-- Product Image -->
        <div class="col-md-6">
            <div class="card border-0 bg-dark overflow-hidden rounded-4 shadow-lg">
                <div id="productCarousel" class="carousel slide" data-bs-ride="false">
                    <div class="carousel-inner" id="carouselInner" style="height: 500px;">
                        <!-- Images will be loaded here -->
                        <div class="carousel-item active h-100">
                            <img id="productImage" src="" class="d-block w-100 h-100 object-fit-cover"
                                alt="Product Image" style="object-fit: contain;">
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel"
                        data-bs-slide="prev" id="carouselPrevBtn" style="display: none;">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel"
                        data-bs-slide="next" id="carouselNextBtn" style="display: none;">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>

                    <div class="position-absolute top-0 start-0 m-4" style="z-index: 10;">
                        <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fw-bold"
                            id="productCategory"></span>
                    </div>
                </div>

                <!-- Thumbnails Container -->
                <div class="d-flex justify-content-center gap-2 p-3 bg-secondary bg-opacity-10 overflow-auto"
                    id="carouselThumbnails">
                    <!-- Thumbnails will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-md-6">
            <div class="d-flex flex-column h-100">
                <h1 class="display-5 fw-bold text-dark mb-1" id="productName">Carregando...</h1>

                <!-- Dynamic Rating Summary -->
                <div class="d-flex align-items-center mb-2" id="ratingSummaryContainer"
                    style="display: none !important;">
                    <div class="text-warning me-3" id="ratingStars"></div>
                    <span class="text-muted small" id="ratingCount"></span>
                </div>

                <h2 class="display-6 fw-bold text-warning mb-2" id="productPrice">R$ --,--</h2>

                <p class="lead text-muted mb-3 fs-6" id="productDescription">
                    Carregando detalhes do produto...
                </p>

                <!-- Options -->
                <div class="row g-2 mb-3">
                    <div class="col-12" id="colorOptionsContainer">
                        <!-- Color options will be dynamically loaded here -->
                    </div>
                    <div class="col-12" id="sizeOptionsContainer">
                        <label class="form-label text-muted small text-uppercase fw-bold mb-1">Tamanho</label>
                        <div class="d-flex flex-wrap gap-2" id="sizeButtons">
                            <!-- Size buttons will be dynamically loaded here -->
                        </div>
                    </div>
                    <div class="col-6 mt-2">
                        <label class="form-label text-muted small text-uppercase fw-bold">Quantidade</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary rounded-start-pill" type="button"
                                onclick="adjustQty(-1)">-</button>
                            <input type="text" class="form-control bg-dark text-white border-secondary text-center"
                                value="1" id="productQty" readonly>
                            <button class="btn btn-outline-secondary rounded-end-pill" type="button"
                                onclick="adjustQty(1)">+</button>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-grid gap-3">
                    <button class="btn btn-warning btn-lg rounded-pill py-3 fw-bold shadow-lg"
                        onclick="addToCartCurrent()">
                        <i class="fa-solid fa-cart-plus me-2"></i> Adicionar ao Carrinho
                    </button>
                    <button class="btn btn-success btn-lg rounded-pill py-3 fw-bold shadow-lg" onclick="buyNow()">
                        <i class="fa-solid fa-bolt me-2"></i> Comprar Agora
                    </button>
                    <button class="btn btn-outline-warning btn-lg rounded-pill py-3 fw-bold">
                        <i class="fa-regular fa-heart me-2"></i> Adicionar aos Favoritos
                    </button>
                </div>

                <!-- Extra Info -->
                <div class="mt-3 pt-3 border-top border-secondary">
                    <div class="d-flex align-items-center text-muted small mb-2">
                        <i class="fas fa-truck me-2"></i> Frete Grátis para compras acima de R$ 299
                    </div>
                    <div class="d-flex align-items-center text-muted small">
                        <i class="fas fa-undo me-2"></i> Devolução grátis em até 7 dias
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="fw-bold mb-0">Avaliações dos Clientes</h3>
                <button class="btn btn-outline-dark rounded-pill" id="writeReviewBtn" onclick="openReviewModal()"
                    style="display: none;">
                    <i class="fas fa-pen me-2"></i>Escrever Avaliação
                </button>
            </div>

            <div id="reviewsContainer" class="row g-4">
                <!-- Reviews will be loaded here -->
                <div class="col-12 text-center py-4 text-muted">
                    <p>Carregando avaliações...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" style="font-family: 'Outfit', sans-serif;">Avaliar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <form id="reviewForm">
                    <div class="mb-4 text-center">
                        <label class="form-label d-block fw-bold text-muted small text-uppercase mb-2">Sua Nota</label>
                        <div class="rating-stars mb-2">
                            <input type="radio" name="nota" value="5" id="star5"><label for="star5"
                                title="Excelente">☆</label>
                            <input type="radio" name="nota" value="4" id="star4"><label for="star4"
                                title="Muito Bom">☆</label>
                            <input type="radio" name="nota" value="3" id="star3"><label for="star3"
                                title="Bom">☆</label>
                            <input type="radio" name="nota" value="2" id="star2"><label for="star2"
                                title="Ruim">☆</label>
                            <input type="radio" name="nota" value="1" id="star1"><label for="star1"
                                title="Péssimo">☆</label>
                        </div>
                        <div id="ratingLabel" class="fw-bold text-warning small" style="min-height: 20px;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="reviewComment"
                            class="form-label fw-bold text-muted small text-uppercase">Comentário</label>
                        <textarea class="form-control bg-light border-0" id="reviewComment" rows="4"
                            placeholder="Conte-nos o que você achou do produto..." style="resize: none;"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="reviewMedia" class="form-label fw-bold text-muted small text-uppercase">Fotos ou
                            Vídeo (Opcional)</label>
                        <input class="form-control bg-light border-0" type="file" id="reviewMedia" multiple
                            accept="image/*,video/*">
                        <div class="form-text small text-muted mt-1"><i class="fas fa-info-circle me-1"></i>Máximo 3
                            arquivos.</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning fw-bold rounded-pill py-2 shadow-sm">Enviar
                            Avaliação</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .rating-stars {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        gap: 8px;
    }

    .rating-stars input {
        display: none;
    }

    .rating-stars label {
        font-size: 2.5rem;
        color: #e0e0e0;
        cursor: pointer;
        transition: color 0.2s, transform 0.2s;
    }

    .rating-stars input:checked~label,
    .rating-stars label:hover,
    .rating-stars label:hover~label {
        color: #ffc107;
    }

    .rating-stars label:hover {
        transform: scale(1.1);
    }

    .review-media-preview {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }

    /* Product Zoom Styles - Desktop Only */
    @media (hover: hover) {
        .product-zoom-container {
            overflow: hidden !important;
            cursor: zoom-in;
        }

        .product-zoom-container img {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }
    }
</style>

<!-- Modal Public Profile -->
<div class="modal fade" id="modalPublicProfile" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-body p-0">
                <div class="bg-dark text-white p-4 text-center position-relative"
                    style="background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                    <div class="position-relative d-inline-block mb-3">
                        <img id="ppPhoto" src="/static/img/default_avatar.png"
                            class="rounded-circle border border-4 border-warning shadow" width="100" height="100"
                            style="object-fit: cover;">
                        <span
                            class="position-absolute bottom-0 end-0 bg-success border border-2 border-dark rounded-circle p-2"
                            title="Verificado"></span>
                    </div>
                    <h4 id="ppName" class="fw-bold mb-1">Nome do Cliente</h4>
                    <p id="ppMemberSince" class="text-white-50 small mb-0"><i class="far fa-calendar-alt me-1"></i>
                        Membro desde Janeiro 2024</p>
                </div>
                <div class="p-4 bg-white">
                    <div class="d-flex justify-content-between text-center mb-4">
                        <div class="w-100">
                            <h3 id="ppTotalReviews" class="fw-bold text-warning mb-0">0</h3>
                            <small class="text-muted text-uppercase fw-bold"
                                style="font-size: 0.7rem;">Avaliações</small>
                        </div>
                        <div class="vr"></div>
                        <div class="w-100">
                            <h3 class="fw-bold text-dark mb-0">5.0</h3> <!-- Placeholder for avg rating if available -->
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Média</small>
                        </div>
                    </div>

                    <h6 class="fw-bold text-uppercase text-muted small mb-3">Últimas Avaliações</h6>
                    <div id="ppReviewsList" class="vstack gap-3">
                        <!-- Reviews loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="imageLightboxModal" class="lightbox-modal">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <div class="lightbox-content-wrapper">
        <span class="lightbox-prev" onclick="changeImage(-1)">&#10094;</span>
        <div class="lightbox-media-container">
            <!-- Media will be injected here -->
            <img id="lightboxImage" src="" alt="Zoomed Image">
            <video id="lightboxVideo" controls style="display:none;"></video>
        </div>
        <span class="lightbox-next" onclick="changeImage(1)">&#10095;</span>
    </div>
</div>

<style>
    .lightbox-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(5px);
        justify-content: center;
        align-items: center;
    }

    .lightbox-content-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .lightbox-media-container {
        max-width: 90%;
        max-height: 90%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .lightbox-media-container img,
    .lightbox-media-container video {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
        z-index: 10000;
    }

    .lightbox-close:hover,
    .lightbox-close:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }

    .lightbox-prev,
    .lightbox-next {
        cursor: pointer;
        position: absolute;
        top: 50%;
        width: auto;
        padding: 16px;
        margin-top: -50px;
        color: white;
        font-weight: bold;
        font-size: 30px;
        transition: 0.6s ease;
        border-radius: 0 3px 3px 0;
        user-select: none;
        background-color: rgba(0, 0, 0, 0.3);
    }

    .lightbox-next {
        right: 0;
        border-radius: 3px 0 0 3px;
    }

    .lightbox-prev {
        left: 0;
        border-radius: 3px 0 0 3px;
    }

    .lightbox-prev:hover,
    .lightbox-next:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }

    /* Hide arrows if single image */
    .lightbox-arrow-hidden {
        display: none !important;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    // Global variables
    const productId = window.location.pathname.split('/').pop();
    let currentProduct = null;
    let allVariants = [];
    let selectedColor = null;
    let selectedSize = null;
    // Renamed to avoid collision with main.js or other scripts
    const clientPageToken = localStorage.getItem('clientToken') || sessionStorage.getItem('clientToken');

    // Color Mapping (Portuguese -> Hex)
    const colorMap = {
        'preto': '#000000', 'branco': '#FFFFFF', 'cinza': '#808080', 'azul': '#0000FF',
        'vermelho': '#FF0000', 'verde': '#008000', 'amarelo': '#FFFF00', 'rosa': '#FFC0CB',
        'roxo': '#800080', 'laranja': '#FFA500', 'bege': '#F5F5DC', 'marrom': '#A52A2A',
        'vinho': '#800000', 'marinho': '#000080', 'ciano': '#00FFFF', 'magenta': '#FF00FF',
        'lilas': '#C8A2C8', 'coral': '#FF7F50', 'turquesa': '#40E0D0', 'dourado': '#FFD700',
        'prata': '#C0C0C0'
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadProductDetails();
        loadReviews();
        checkReviewEligibility();
        setupRatingInteractions();
    });


    function setupRatingInteractions() {
        const labels = {
            '1': 'Péssimo',
            '2': 'Ruim',
            '3': 'Bom',
            '4': 'Muito Bom',
            '5': 'Excelente'
        };
        const ratingLabel = document.getElementById('ratingLabel');
        const stars = document.querySelectorAll('.rating-stars input');

        stars.forEach(star => {
            // Hover effect
            star.nextElementSibling.addEventListener('mouseenter', () => {
                ratingLabel.textContent = labels[star.value];
            });

            // Click effect (persist label)
            star.addEventListener('change', () => {
                ratingLabel.textContent = labels[star.value];
            });
        });

        // Reset label when mouse leaves the stars container, unless a star is selected
        document.querySelector('.rating-stars').addEventListener('mouseleave', () => {
            const checked = document.querySelector('.rating-stars input:checked');
            if (checked) {
                ratingLabel.textContent = labels[checked.value];
            } else {
                ratingLabel.textContent = '';
            }
        });
    }

    async function loadProductDetails() {
        try {
            const response = await fetch(`/api/store/products/${productId}?t=${Date.now()}`);
            if (!response.ok) throw new Error('Produto não encontrado');

            const data = await response.json();

            // Filter variants to only include those with stock > 0
            let variants = data.variants || [];
            if (variants.length === 0 && data.quantidade > 0) {
                variants = [data];
            }

            // Ensure allVariants only contains in-stock items
            allVariants = variants.filter(v => v.quantidade > 0);

            if (allVariants.length === 0) {
                Swal.fire({
                    icon: 'error', title: 'Esgotado', text: 'Este produto está esgotado.',
                    background: '#1e1e1e', color: '#fff'
                }).then(() => { window.location.href = '/store'; });
                return;
            }

            // Check if the main loaded product has stock. If not, switch to the first available variant.
            if (data.quantidade <= 0) {
                currentProduct = allVariants[0];
            } else {
                currentProduct = data;
            }

            // Initial Render
            renderProductInfo(currentProduct);
            initializeOptions();

        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: 'error', title: 'Erro', text: 'Não foi possível carregar o produto.',
                background: '#1e1e1e', color: '#fff'
            }).then(() => { window.location.href = '/store'; });
        }
    }

    function renderProductInfo(product) {
        document.title = `${product.nome} | FP Moda Fitness`;
        document.getElementById('productName').textContent = product.nome;
        document.getElementById('productPrice').textContent = `R$ ${product.preco_venda.toFixed(2)}`;
        document.getElementById('productDescription').textContent = product.descricao || 'Sem descrição disponível.';
        document.getElementById('productCategory').textContent = product.categoria || 'Geral';

        // --- Image Carousel Logic ---
        const carouselInner = document.getElementById('carouselInner');
        const carouselThumbnails = document.getElementById('carouselThumbnails');
        const prevBtn = document.getElementById('carouselPrevBtn');
        const nextBtn = document.getElementById('carouselNextBtn');

        if (!carouselInner) return;

        // Collect all unique images
        let images = [];
        if (product.imagem_url) images.push(product.imagem_url);
        if (product.imagens && product.imagens.length > 0) {
            product.imagens.forEach(img => images.push(img.imagem_url));
        }
        images = [...new Set(images)];

        if (images.length === 0) {
            images.push('https://via.placeholder.com/600x800?text=Sem+Imagem');
        }

        carouselInner.innerHTML = '';
        carouselThumbnails.innerHTML = '';

        images.forEach((imgUrl, index) => {
            const isActive = index === 0 ? 'active' : '';
            const src = imgUrl.startsWith('http') ? imgUrl : `/uploads/${imgUrl}`;

            // ADDED: zoom-container class, REMOVED inline events
            const itemHtml = `
                <div class="carousel-item ${isActive} h-100 product-zoom-container">
                    <img src="${src}" class="d-block w-100 h-100" alt="${product.nome}" 
                         style="object-fit: contain; pointer-events: none;" 
                         oncontextmenu="return false;">
                </div>
            `;
            carouselInner.insertAdjacentHTML('beforeend', itemHtml);
        });

        if (images.length > 1) {
            images.forEach((imgUrl, index) => {
                const src = imgUrl.startsWith('http') ? imgUrl : `/uploads/${imgUrl}`;
                const thumb = document.createElement('img');
                thumb.src = src;
                thumb.className = `rounded border ${index === 0 ? 'border-warning' : 'border-secondary'} object-fit-cover`;
                thumb.style.width = '60px';
                thumb.style.height = '60px';
                thumb.style.cursor = 'pointer';
                thumb.style.opacity = index === 0 ? '1' : '0.6';
                thumb.style.transition = 'all 0.2s';

                thumb.onclick = () => {
                    const carouselEl = document.getElementById('productCarousel');
                    const carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl);
                    carousel.to(index);
                };
                carouselThumbnails.appendChild(thumb);
            });
            prevBtn.style.display = 'block';
            nextBtn.style.display = 'block';
        } else {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }

        const myCarousel = document.getElementById('productCarousel');
        if (!myCarousel.dataset.listenerAttached) {
            myCarousel.addEventListener('slide.bs.carousel', function (e) {
                const index = e.to;
                const thumbs = carouselThumbnails.querySelectorAll('img');
                thumbs.forEach((t, i) => {
                    if (i === index) {
                        t.classList.remove('border-secondary');
                        t.classList.add('border-warning');
                        t.style.opacity = '1';
                    } else {
                        t.classList.remove('border-warning');
                        t.classList.add('border-secondary');
                        t.style.opacity = '0.6';
                    }
                });
            });
            myCarousel.dataset.listenerAttached = 'true';
        }

        // Initialize Zoom only for Desktops
        setupZoomInteractions();
    }

    // --- Zoom Functions ---
    // Prevent multiple attachments
    let zoomListenersAttached = false;

    function setupZoomInteractions() {
        if (zoomListenersAttached) return;

        // Strict check: Only enable if device supports hover (Mouse)
        if (!window.matchMedia('(hover: hover)').matches) return;

        const carouselInner = document.getElementById('carouselInner');
        if (!carouselInner) return;

        carouselInner.addEventListener('mousemove', function (e) {
            const container = e.target.closest('.product-zoom-container');
            if (container) zoom(e, container);
        });

        carouselInner.addEventListener('mouseout', function (e) {
            const container = e.target.closest('.product-zoom-container');
            // Check if we actually left the container (not just moved to a child)
            if (container && !container.contains(e.relatedTarget)) {
                unzoom(container);
            }
        });

        zoomListenersAttached = true;
    }

    function zoom(e, container) {
        const img = container.querySelector('img');
        const rect = container.getBoundingClientRect();

        // Calculate position percentage
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;

        img.style.transformOrigin = `${x}% ${y}%`;
        img.style.transform = "scale(2.5)"; // Zoom level
        img.style.cursor = "zoom-in";
    }

    function unzoom(container) {
        const img = container.querySelector('img');
        img.style.transformOrigin = "center center";
        img.style.transform = "scale(1)";
        img.style.cursor = "default";
    }

    function initializeOptions() {
        const colors = [...new Set(allVariants.map(v => v.cor).filter(Boolean))];
        const colorContainer = document.getElementById('colorOptionsContainer');
        if (colors.length > 0) {
            colorContainer.innerHTML = `
                <label class="form-label text-muted small text-uppercase fw-bold" id="colorLabel">Cor</label>
                <div class="d-flex gap-2 flex-wrap">
                    ${colors.map(color => {
                const variant = allVariants.find(v => v.cor === color);
                const hex = variant ? (variant.cor_hex || colorMap[color.toLowerCase()] || '#CCCCCC') : '#CCCCCC';
                const isWhite = hex.toUpperCase() === '#FFFFFF';
                return `
                        <div class="position-relative">
                            <input type="radio" class="btn-check" name="colorOption" id="color_${color}" value="${color}" autocomplete="off" onchange="handleColorChange('${color}')">
                            <label class="btn rounded-circle p-0 d-flex align-items-center justify-content-center shadow-sm" 
                                   for="color_${color}" 
                                   style="width: 40px; height: 40px; background-color: ${hex}; border: 2px solid ${isWhite ? '#ccc' : hex}; cursor: pointer;"
                                   title="${color}">
                                   <i class="fas fa-check text-${isWhite ? 'dark' : 'white'} opacity-0 check-icon"></i>
                            </label>
                        </div>
                    `}).join('')}
                </div>
                <style>
                    .btn-check:checked + label { border-color: #ffc107 !important; transform: scale(1.1); }
                    .btn-check:checked + label .check-icon { opacity: 1 !important; }
                </style>
            `;
            if (colors.length > 0) {
                document.getElementById(`color_${colors[0]}`).checked = true;
                handleColorChange(colors[0]);
            }
        } else {
            colorContainer.innerHTML = '';
            selectedColor = null;
            updateSizeOptions();
        }
    }

    function handleColorChange(color) {
        selectedColor = color;
        const label = document.getElementById('colorLabel');
        if (label) label.innerText = `Cor: ${color}`;
        updateSizeOptions();
        const variant = allVariants.find(v => v.cor === color);
        if (variant) renderProductInfo(variant);
    }

    function updateSizeOptions() {
        const availableVariants = selectedColor ? allVariants.filter(v => v.cor === selectedColor) : allVariants;
        const sizes = [...new Set(availableVariants.map(v => v.tamanho).filter(Boolean))];
        const sizeContainer = document.getElementById('sizeButtons');

        if (sizes.length > 0) {
            sizeContainer.innerHTML = sizes.map(size => `
                <input type="radio" class="btn-check" name="sizeOption" id="size_${size}" value="${size}" autocomplete="off" onchange="handleSizeChange('${size}')">
                <label class="btn btn-outline-dark px-3 py-2" for="size_${size}">${size}</label>
            `).join('');
            selectedSize = null;
        } else {
            sizeContainer.innerHTML = '<span class="text-muted small">Tamanho único / Indisponível</span>';
            selectedSize = null;
        }
    }

    function handleSizeChange(size) {
        selectedSize = size;
        const variant = findSelectedVariant();
        if (variant) renderProductInfo(variant);
    }

    function findSelectedVariant() {
        return allVariants.find(v => (!selectedColor || v.cor === selectedColor) && (!selectedSize || v.tamanho === selectedSize));
    }

    function adjustQty(delta) {
        const input = document.getElementById('productQty');
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        const variant = findSelectedVariant();
        if (variant && val > variant.quantidade) {
            val = variant.quantidade;
            Swal.fire({ icon: 'warning', title: 'Estoque Limitado', text: `Apenas ${variant.quantidade} unidades disponíveis.`, toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
        }
        input.value = val;
    }

    function addToCartCurrent() {
        const variant = findSelectedVariant();
        if (allVariants.some(v => v.cor) && !selectedColor) {
            Swal.fire({ icon: 'info', title: 'Selecione uma cor', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }
        if (allVariants.some(v => v.tamanho) && !selectedSize) {
            Swal.fire({ icon: 'info', title: 'Selecione um tamanho', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }
        if (!variant && allVariants.length > 1) {
            Swal.fire({ icon: 'error', title: 'Produto indisponível', text: 'Combinação não encontrada.', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }

        const finalProduct = variant || currentProduct;
        const qty = parseInt(document.getElementById('productQty').value);
        let cart = JSON.parse(localStorage.getItem('fp_fitness_cart')) || [];
        const existingItem = cart.find(item => item.id === finalProduct.id && item.color === (finalProduct.cor || null) && item.size === (finalProduct.tamanho || null));

        if (existingItem) {
            existingItem.quantity += qty;
        } else {
            cart.push({
                id: finalProduct.id, quantity: qty, size: finalProduct.tamanho || null, color: finalProduct.cor || null,
                nome: finalProduct.nome, price: finalProduct.preco_venda, image: finalProduct.imagem_url
            });
        }
        localStorage.setItem('fp_fitness_cart', JSON.stringify(cart));
        updateCartCount();
        Swal.fire({
            icon: 'success',
            title: 'Produto Adicionado!',
            text: 'Indo para o carrinho...',
            timer: 800,
            showConfirmButton: false,
            background: '#1e1e1e',
            color: '#fff'
        }).then(() => {
            window.location.href = '/store/carrinho';
        });
    }

    function buyNow() {
        const variant = findSelectedVariant();
        if (allVariants.some(v => v.cor) && !selectedColor) {
            Swal.fire({ icon: 'info', title: 'Selecione uma cor', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }
        if (allVariants.some(v => v.tamanho) && !selectedSize) {
            Swal.fire({ icon: 'info', title: 'Selecione um tamanho', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }
        if (!variant && allVariants.length > 1) {
            Swal.fire({ icon: 'error', title: 'Produto indisponível', text: 'Combinação não encontrada.', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }

        const finalProduct = variant || currentProduct;
        const qty = parseInt(document.getElementById('productQty').value);
        let cart = JSON.parse(localStorage.getItem('fp_fitness_cart')) || [];
        const existingItem = cart.find(item => item.id === finalProduct.id && item.color === (finalProduct.cor || null) && item.size === (finalProduct.tamanho || null));

        if (existingItem) {
            existingItem.quantity += qty;
        } else {
            cart.push({
                id: finalProduct.id, quantity: qty, size: finalProduct.tamanho || null, color: finalProduct.cor || null,
                nome: finalProduct.nome, price: finalProduct.preco_venda, image: finalProduct.imagem_url
            });
        }
        localStorage.setItem('fp_fitness_cart', JSON.stringify(cart));
        updateCartCount();

        // Direct redirect to checkout
        window.location.href = '/store/checkout';
    }

    // --- REVIEWS LOGIC ---

    // --- LIGHTBOX LOGIC ---
    let currentLightboxMedia = [];
    let currentLightboxIndex = 0;

    function openLightbox(index, mediaJsonEncoded) {
        // Decode hidden JSON
        const media = JSON.parse(decodeURIComponent(mediaJsonEncoded));
        currentLightboxMedia = media;
        currentLightboxIndex = index;

        const modal = document.getElementById('imageLightboxModal');
        modal.style.display = 'flex'; // Flex to center
        updateLightboxContent();

        // Keyboard navigation
        document.addEventListener('keydown', handleLightboxKeys);
    }

    function closeLightbox() {
        const modal = document.getElementById('imageLightboxModal');
        modal.style.display = 'none';

        // Stop video if playing
        const video = document.getElementById('lightboxVideo');
        video.pause();
        video.src = "";

        document.removeEventListener('keydown', handleLightboxKeys);
    }

    function changeImage(direction) {
        currentLightboxIndex += direction;
        // Loop
        if (currentLightboxIndex >= currentLightboxMedia.length) currentLightboxIndex = 0;
        if (currentLightboxIndex < 0) currentLightboxIndex = currentLightboxMedia.length - 1;

        updateLightboxContent();
    }

    function updateLightboxContent() {
        const img = document.getElementById('lightboxImage');
        const video = document.getElementById('lightboxVideo');
        const prevBtn = document.querySelector('.lightbox-prev');
        const nextBtn = document.querySelector('.lightbox-next');

        const item = currentLightboxMedia[currentLightboxIndex];
        const src = `/static/uploads/reviews/${item.url}`;

        if (item.tipo === 'video') {
            img.style.display = 'none';
            video.style.display = 'block';
            video.src = src;
        } else {
            video.style.display = 'none';
            video.pause();
            img.style.display = 'block';
            img.src = src;
        }

        // Hide arrows if only 1 item
        if (currentLightboxMedia.length <= 1) {
            prevBtn.classList.add('lightbox-arrow-hidden');
            nextBtn.classList.add('lightbox-arrow-hidden');
        } else {
            prevBtn.classList.remove('lightbox-arrow-hidden');
            nextBtn.classList.remove('lightbox-arrow-hidden');
        }
    }

    function handleLightboxKeys(e) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') changeImage(1);
        if (e.key === 'ArrowLeft') changeImage(-1);
    }

    // Close on background click
    document.getElementById('imageLightboxModal').addEventListener('click', (e) => {
        if (e.target.id === 'imageLightboxModal' || e.target.classList.contains('lightbox-content-wrapper')) {
            closeLightbox();
        }
    });

    async function loadReviews() {
        try {
            const headers = clientPageToken ? { 'x-client-token': clientPageToken } : {};
            const res = await fetch(`/api/store/products/${productId}/reviews`, { headers });
            const reviews = await res.json();
            const container = document.getElementById('reviewsContainer');
            const ratingSummary = document.getElementById('ratingSummaryContainer');
            const ratingStars = document.getElementById('ratingStars');
            const ratingCount = document.getElementById('ratingCount');

            if (reviews.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-4 text-muted"><p>Seja o primeiro a avaliar este produto!</p></div>';
                ratingSummary.style.setProperty('display', 'none', 'important');
                return;
            }

            // Calculate Average
            const totalStars = reviews.reduce((acc, r) => acc + r.nota, 0);
            const avg = totalStars / reviews.length;

            // Render Stars Summary
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= Math.round(avg)) starsHtml += '<i class="fas fa-star"></i>';
                else starsHtml += '<i class="far fa-star"></i>';
            }
            ratingStars.innerHTML = starsHtml;
            ratingCount.textContent = `(${avg.toFixed(1)} de ${reviews.length} avaliações)`;
            ratingSummary.style.setProperty('display', 'flex', 'important');

            // Render Reviews
            container.innerHTML = reviews.map(r => {
                // Prepare media JSON for lightbox
                const mediaJson = encodeURIComponent(JSON.stringify(r.midias));

                return `
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex align-items-center mb-3">
                                    <img src="${r.cliente_foto || '/static/img/default_avatar.png'}" 
                                         class="rounded-circle me-3 border border-2 border-warning" 
                                         width="50" height="50" style="object-fit: cover; cursor: pointer;"
                                         onclick="openPublicProfile(${r.id_cliente})">
                                    <div>
                                        <h6 class="fw-bold mb-0 text-dark" style="cursor: pointer;" onclick="openPublicProfile(${r.id_cliente})">${r.cliente_nome}</h6>
                                        <small class="text-muted">${r.data_criacao}</small>
                                    </div>
                                </div>
                                ${r.is_own ? `
                                    <div class="dropdown">
                                        <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="editReview(${r.id}, '${r.comentario || ''}', ${r.nota})"><i class="fas fa-edit me-2"></i>Editar</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteReview(${r.id})"><i class="fas fa-trash-alt me-2"></i>Excluir</a></li>
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-warning mb-2 h5">
                                ${Array(r.nota).fill('<i class="fas fa-star"></i>').join('')}
                                ${Array(5 - r.nota).fill('<i class="far fa-star"></i>').join('')}
                            </div>
                            <p class="card-text text-muted">${r.comentario || ''}</p>
                            ${r.midias.length > 0 ? `
                                <div class="d-flex gap-2 mt-2 overflow-auto">
                                    ${r.midias.map((m, idx) => m.tipo === 'foto'
                    ? `<img src="/static/uploads/reviews/${m.url}" class="review-media-preview" onclick="openLightbox(${idx}, '${mediaJson}')">`
                    : `<video src="/static/uploads/reviews/${m.url}" class="review-media-preview" onclick="openLightbox(${idx}, '${mediaJson}')"></video>` // Video thumbnail click logic
                ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');

        } catch (error) {
            console.error('Erro ao carregar avaliações:', error);
        }
    }

    // Edit/Delete Logic
    window.deleteReview = async (id) => {
        const result = await Swal.fire({
            title: 'Tem certeza?',
            text: "Deseja excluir sua avaliação? Você poderá avaliar novamente.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sim, excluir',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetch(`/api/store/reviews/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-client-token': clientPageToken }
                });
                if (res.ok) {
                    Swal.fire('Excluído!', 'Sua avaliação foi removida.', 'success');
                    loadReviews();
                    // Optional: reload page to refresh eligibility status visually if needed
                } else {
                    Swal.fire('Erro', 'Não foi possível excluir.', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('Erro', 'Erro de conexão.', 'error');
            }
        }
    };

    window.editReview = async (id, currentComment, currentRating) => {
        const { value: formValues } = await Swal.fire({
            title: 'Editar Avaliação',
            html: `
                    <div class="mb-3">
                    <label class="form-label">Nota</label>
                    <div class="rating-input d-flex justify-content-center gap-2 fs-3 text-warning">
                        ${[1, 2, 3, 4, 5].map(i => `<i class="far fa-star star-edit" data-value="${i}" style="cursor: pointer;"></i>`).join('')}
                    </div>
                    <input type="hidden" id="swal-rating" value="${currentRating}">
                </div>
                <textarea id="swal-comment" class="form-control" placeholder="Seu comentário...">${currentComment}</textarea>
            `,
            didOpen: () => {
                const stars = document.querySelectorAll('.star-edit');
                const input = document.getElementById('swal-rating');

                function updateStars(val) {
                    stars.forEach(s => {
                        const v = parseInt(s.dataset.value);
                        s.classList.toggle('fas', v <= val);
                        s.classList.toggle('far', v > val);
                    });
                }
                updateStars(currentRating); // Init

                stars.forEach(s => {
                    s.addEventListener('click', () => {
                        const val = parseInt(s.dataset.value);
                        input.value = val;
                        updateStars(val);
                    });
                });
            },
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            preConfirm: () => {
                return {
                    nota: document.getElementById('swal-rating').value,
                    comentario: document.getElementById('swal-comment').value
                }
            }
        });

        if (formValues) {
            try {
                const res = await fetch(`/api/store/reviews/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-client-token': clientPageToken
                    },
                    body: JSON.stringify(formValues)
                });

                if (res.ok) {
                    Swal.fire('Sucesso', 'Avaliação atualizada!', 'success');
                    loadReviews();
                } else {
                    Swal.fire('Erro', 'Erro ao atualizar.', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }
    };

    async function openPublicProfile(clienteId) {
        try {
            const modal = new bootstrap.Modal(document.getElementById('modalPublicProfile'));
            modal.show(); // Show loading state

            const res = await fetch(`/api/public/perfil/${clienteId}`);
            if (!res.ok) throw new Error("Perfil não encontrado");

            const data = await res.json();

            document.getElementById('ppName').textContent = data.nome;
            document.getElementById('ppPhoto').src = data.foto_perfil;
            document.getElementById('ppMemberSince').innerHTML = `<i class="far fa-calendar-alt me-1"></i> Membro desde ${data.membro_desde}`;
            document.getElementById('ppTotalReviews').textContent = data.total_avaliacoes;

            const reviewsList = document.getElementById('ppReviewsList');
            if (data.ultimas_avaliacoes.length === 0) {
                reviewsList.innerHTML = '<p class="text-center text-muted small">Nenhuma avaliação recente.</p>';
            } else {
                reviewsList.innerHTML = data.ultimas_avaliacoes.map(r => `
                <div class="d-flex gap-3 align-items-center border-bottom pb-2">
                <img src="${r.produto_img || '/placeholder.jpg'}" class="rounded" width="50" height="50" style="object-fit: cover;">
                    <div>
                        <div class="small fw-bold text-dark">${r.produto_nome}</div>
                        <div class="text-warning small">${'★'.repeat(r.nota)}${'☆'.repeat(5 - r.nota)}</div>
                        <div class="text-muted small text-truncate" style="font-style: italic;">"${r.comentario || ''}"</div>
                    </div>
                    <small class="ms-auto text-muted" style="font-size: 0.7rem;">${r.data}</small>
                </div>
                `).join('');
            }
        } catch (e) {
            console.error(e);
            // Fail silently or toast
        }
    }

    async function checkReviewEligibility() {
        if (!clientPageToken) return;
        try {
            const res = await fetch(`/api/store/products/${productId}/can_review`, {
                headers: { 'x-client-token': clientPageToken }
            });
            const data = await res.json();
            if (data.can_review) {
                document.getElementById('writeReviewBtn').style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao verificar elegibilidade:', error);
        }
    }

    function openReviewModal() {
        new bootstrap.Modal(document.getElementById('reviewModal')).show();
    }

    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        const nota = document.querySelector('input[name="nota"]:checked')?.value;
        const comentario = document.getElementById('reviewComment').value;
        const files = document.getElementById('reviewMedia').files;

        if (!nota) {
            Swal.fire({ icon: 'warning', title: 'Nota obrigatória', text: 'Por favor, selecione uma nota de 1 a 5.' });
            return;
        }

        formData.append('nota', nota);
        formData.append('comentario', comentario);
        for (let i = 0; i < files.length; i++) {
            formData.append('midia', files[i]);
        }

        try {
            const res = await fetch(`/api/store/products/${productId}/reviews`, {
                method: 'POST',
                headers: { 'x-client-token': clientPageToken },
                body: formData
            });
            const result = await res.json();

            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                Swal.fire({ icon: 'success', title: 'Sucesso!', text: 'Sua avaliação foi enviada.' });
                loadReviews();
                document.getElementById('writeReviewBtn').style.display = 'none'; // Hide button after review
            } else {
                Swal.fire({ icon: 'error', title: 'Erro', text: result.erro || 'Erro ao enviar avaliação.' });
            }
        } catch (error) {
            console.error(error);
            Swal.fire({ icon: 'error', title: 'Erro', text: 'Erro de conexão.' });
        }
    });
</script>
{% endblock %}