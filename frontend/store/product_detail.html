{% extends "store/base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row g-5">
        <!-- Product Image -->
        <div class="col-md-6">
            <div class="card border-0 bg-dark overflow-hidden rounded-4 shadow-lg">
                <div id="productCarousel" class="carousel slide" data-bs-ride="false">
                    <div class="carousel-inner" id="carouselInner" style="height: 500px;">
                        <!-- Images will be loaded here -->
                        <div class="carousel-item active h-100">
                            <img id="productImage" src="" class="d-block w-100 h-100 object-fit-cover"
                                alt="Product Image" style="object-fit: contain;">
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel"
                        data-bs-slide="prev" id="carouselPrevBtn" style="display: none;">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel"
                        data-bs-slide="next" id="carouselNextBtn" style="display: none;">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>

                    <div class="position-absolute top-0 start-0 m-4" style="z-index: 10;">
                        <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fw-bold"
                            id="productCategory"></span>
                    </div>
                </div>

                <!-- Thumbnails Container -->
                <div class="d-flex justify-content-center gap-2 p-3 bg-secondary bg-opacity-10 overflow-auto"
                    id="carouselThumbnails">
                    <!-- Thumbnails will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-md-6">
            <div class="d-flex flex-column h-100">
                <h1 class="display-5 fw-bold text-dark mb-1" id="productName">Carregando...</h1>

                <!-- Dynamic Rating Summary -->
                <div class="d-flex align-items-center mb-2" id="ratingSummaryContainer"
                    style="display: none !important;">
                    <div class="text-warning me-3" id="ratingStars"></div>
                    <span class="text-muted small" id="ratingCount"></span>
                </div>

                <h2 class="display-6 fw-bold text-warning mb-2" id="productPrice">R$ --,--</h2>

                <p class="lead text-muted mb-3 fs-6" id="productDescription">
                    Carregando detalhes do produto...
                </p>

                <!-- Options -->
                <div class="row g-2 mb-3">
                    <div class="col-12" id="colorOptionsContainer">
                        <!-- Color options will be dynamically loaded here -->
                    </div>
                    <div class="col-12" id="sizeOptionsContainer">
                        <label class="form-label text-muted small text-uppercase fw-bold mb-1">Tamanho</label>
                        <div class="d-flex flex-wrap gap-2" id="sizeButtons">
                            <!-- Size buttons will be dynamically loaded here -->
                        </div>
                    </div>
                    <div class="col-6 mt-2">
                        <label class="form-label text-muted small text-uppercase fw-bold">Quantidade</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary rounded-start-pill" type="button"
                                onclick="adjustQty(-1)">-</button>
                            <input type="text" class="form-control bg-dark text-white border-secondary text-center"
                                value="1" id="productQty" readonly>
                            <button class="btn btn-outline-secondary rounded-end-pill" type="button"
                                onclick="adjustQty(1)">+</button>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-grid gap-3">
                    <button class="btn btn-warning btn-lg rounded-pill py-3 fw-bold shadow-lg"
                        onclick="addToCartCurrent()">
                        <i class="fa-solid fa-cart-plus me-2"></i> Adicionar ao Carrinho
                    </button>
                    <button class="btn btn-outline-warning btn-lg rounded-pill py-3 fw-bold">
                        <i class="fa-regular fa-heart me-2"></i> Adicionar aos Favoritos
                    </button>
                </div>

                <!-- Extra Info -->
                <div class="mt-3 pt-3 border-top border-secondary">
                    <div class="d-flex align-items-center text-muted small mb-2">
                        <i class="fas fa-truck me-2"></i> Frete Grátis para compras acima de R$ 299
                    </div>
                    <div class="d-flex align-items-center text-muted small">
                        <i class="fas fa-undo me-2"></i> Devolução grátis em até 7 dias
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="fw-bold mb-0">Avaliações dos Clientes</h3>
                <button class="btn btn-outline-dark rounded-pill" id="writeReviewBtn" onclick="openReviewModal()"
                    style="display: none;">
                    <i class="fas fa-pen me-2"></i>Escrever Avaliação
                </button>
            </div>

            <div id="reviewsContainer" class="row g-4">
                <!-- Reviews will be loaded here -->
                <div class="col-12 text-center py-4 text-muted">
                    <p>Carregando avaliações...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" style="font-family: 'Outfit', sans-serif;">Avaliar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <form id="reviewForm">
                    <div class="mb-4 text-center">
                        <label class="form-label d-block fw-bold text-muted small text-uppercase mb-2">Sua Nota</label>
                        <div class="rating-stars mb-2">
                            <input type="radio" name="nota" value="5" id="star5"><label for="star5"
                                title="Excelente">☆</label>
                            <input type="radio" name="nota" value="4" id="star4"><label for="star4"
                                title="Muito Bom">☆</label>
                            <input type="radio" name="nota" value="3" id="star3"><label for="star3"
                                title="Bom">☆</label>
                            <input type="radio" name="nota" value="2" id="star2"><label for="star2"
                                title="Ruim">☆</label>
                            <input type="radio" name="nota" value="1" id="star1"><label for="star1"
                                title="Péssimo">☆</label>
                        </div>
                        <div id="ratingLabel" class="fw-bold text-warning small" style="min-height: 20px;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="reviewComment"
                            class="form-label fw-bold text-muted small text-uppercase">Comentário</label>
                        <textarea class="form-control bg-light border-0" id="reviewComment" rows="4"
                            placeholder="Conte-nos o que você achou do produto..." style="resize: none;"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="reviewMedia" class="form-label fw-bold text-muted small text-uppercase">Fotos ou
                            Vídeo (Opcional)</label>
                        <input class="form-control bg-light border-0" type="file" id="reviewMedia" multiple
                            accept="image/*,video/*">
                        <div class="form-text small text-muted mt-1"><i class="fas fa-info-circle me-1"></i>Máximo 3
                            arquivos.</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning fw-bold rounded-pill py-2 shadow-sm">Enviar
                            Avaliação</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .rating-stars {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        gap: 8px;
    }

    .rating-stars input {
        display: none;
    }

    .rating-stars label {
        font-size: 2.5rem;
        color: #e0e0e0;
        cursor: pointer;
        transition: color 0.2s, transform 0.2s;
    }

    .rating-stars input:checked~label,
    .rating-stars label:hover,
    .rating-stars label:hover~label {
        color: #ffc107;
    }

    .rating-stars label:hover {
        transform: scale(1.1);
    }

    .review-media-preview {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid #dee2e6;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    const productId = window.location.pathname.split('/').pop();
    let currentProduct = null;
    let allVariants = [];
    let selectedColor = null;
    let selectedSize = null;
    const token = localStorage.getItem('clientToken') || sessionStorage.getItem('clientToken');

    // Color Mapping (Portuguese -> Hex)
    const colorMap = {
        'preto': '#000000', 'branco': '#FFFFFF', 'cinza': '#808080', 'azul': '#0000FF',
        'vermelho': '#FF0000', 'verde': '#008000', 'amarelo': '#FFFF00', 'rosa': '#FFC0CB',
        'roxo': '#800080', 'laranja': '#FFA500', 'bege': '#F5F5DC', 'marrom': '#A52A2A',
        'vinho': '#800000', 'marinho': '#000080', 'ciano': '#00FFFF', 'magenta': '#FF00FF',
        'lilas': '#C8A2C8', 'coral': '#FF7F50', 'turquesa': '#40E0D0', 'dourado': '#FFD700',
        'prata': '#C0C0C0'
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadProductDetails();
        loadReviews();
        checkReviewEligibility();
        setupRatingInteractions();
    });

    function setupRatingInteractions() {
        const labels = {
            '1': 'Péssimo',
            '2': 'Ruim',
            '3': 'Bom',
            '4': 'Muito Bom',
            '5': 'Excelente'
        };
        const ratingLabel = document.getElementById('ratingLabel');
        const stars = document.querySelectorAll('.rating-stars input');

        stars.forEach(star => {
            // Hover effect
            star.nextElementSibling.addEventListener('mouseenter', () => {
                ratingLabel.textContent = labels[star.value];
            });

            // Click effect (persist label)
            star.addEventListener('change', () => {
                ratingLabel.textContent = labels[star.value];
            });
        });

        // Reset label when mouse leaves the stars container, unless a star is selected
        document.querySelector('.rating-stars').addEventListener('mouseleave', () => {
            const checked = document.querySelector('.rating-stars input:checked');
            if (checked) {
                ratingLabel.textContent = labels[checked.value];
            } else {
                ratingLabel.textContent = '';
            }
        });
    }

    async function loadProductDetails() {
        try {
            const response = await fetch(`/api/store/products/${productId}`);
            if (!response.ok) throw new Error('Produto não encontrado');

            const data = await response.json();

            // Filter variants to only include those with stock > 0
            let variants = data.variants || [];
            if (variants.length === 0 && data.quantidade > 0) {
                variants = [data];
            }

            // Ensure allVariants only contains in-stock items
            allVariants = variants.filter(v => v.quantidade > 0);

            if (allVariants.length === 0) {
                Swal.fire({
                    icon: 'error', title: 'Esgotado', text: 'Este produto está esgotado.',
                    background: '#1e1e1e', color: '#fff'
                }).then(() => { window.location.href = '/store'; });
                return;
            }

            // Check if the main loaded product has stock. If not, switch to the first available variant.
            if (data.quantidade <= 0) {
                currentProduct = allVariants[0];
            } else {
                currentProduct = data;
            }

            // Initial Render
            renderProductInfo(currentProduct);
            initializeOptions();

        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: 'error', title: 'Erro', text: 'Não foi possível carregar o produto.',
                background: '#1e1e1e', color: '#fff'
            }).then(() => { window.location.href = '/store'; });
        }
    }

    function renderProductInfo(product) {
        document.title = `${product.nome} | FP Moda Fitness`;
        document.getElementById('productName').textContent = product.nome;
        document.getElementById('productPrice').textContent = `R$ ${product.preco_venda.toFixed(2)}`;
        document.getElementById('productDescription').textContent = product.descricao || 'Sem descrição disponível.';
        document.getElementById('productCategory').textContent = product.categoria || 'Geral';

        // --- Image Carousel Logic ---
        const carouselInner = document.getElementById('carouselInner');
        const carouselThumbnails = document.getElementById('carouselThumbnails');
        const prevBtn = document.getElementById('carouselPrevBtn');
        const nextBtn = document.getElementById('carouselNextBtn');

        if (!carouselInner) return;

        // Collect all unique images
        let images = [];
        if (product.imagem_url) images.push(product.imagem_url);
        if (product.imagens && product.imagens.length > 0) {
            product.imagens.forEach(img => images.push(img.imagem_url));
        }
        images = [...new Set(images)];

        if (images.length === 0) {
            images.push('https://via.placeholder.com/600x800?text=Sem+Imagem');
        }

        carouselInner.innerHTML = '';
        carouselThumbnails.innerHTML = '';

        images.forEach((imgUrl, index) => {
            const isActive = index === 0 ? 'active' : '';
            const src = imgUrl.startsWith('http') ? imgUrl : `/uploads/${imgUrl}`;

            const itemHtml = `
                <div class="carousel-item ${isActive} h-100">
                    <img src="${src}" class="d-block w-100 h-100" alt="${product.nome}" style="object-fit: contain;">
                </div>
            `;
            carouselInner.insertAdjacentHTML('beforeend', itemHtml);
        });

        if (images.length > 1) {
            images.forEach((imgUrl, index) => {
                const src = imgUrl.startsWith('http') ? imgUrl : `/uploads/${imgUrl}`;
                const thumb = document.createElement('img');
                thumb.src = src;
                thumb.className = `rounded border ${index === 0 ? 'border-warning' : 'border-secondary'} object-fit-cover`;
                thumb.style.width = '60px';
                thumb.style.height = '60px';
                thumb.style.cursor = 'pointer';
                thumb.style.opacity = index === 0 ? '1' : '0.6';
                thumb.style.transition = 'all 0.2s';

                thumb.onclick = () => {
                    const carouselEl = document.getElementById('productCarousel');
                    const carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl);
                    carousel.to(index);
                };
                carouselThumbnails.appendChild(thumb);
            });
            prevBtn.style.display = 'block';
            nextBtn.style.display = 'block';
        } else {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }

        const myCarousel = document.getElementById('productCarousel');
        if (!myCarousel.dataset.listenerAttached) {
            myCarousel.addEventListener('slide.bs.carousel', function (e) {
                const index = e.to;
                const thumbs = carouselThumbnails.querySelectorAll('img');
                thumbs.forEach((t, i) => {
                    if (i === index) {
                        t.classList.remove('border-secondary');
                        t.classList.add('border-warning');
                        t.style.opacity = '1';
                    } else {
                        t.classList.remove('border-warning');
                        t.classList.add('border-secondary');
                        t.style.opacity = '0.6';
                    }
                });
            });
            myCarousel.dataset.listenerAttached = 'true';
        }
    }

    function initializeOptions() {
        const colors = [...new Set(allVariants.map(v => v.cor).filter(Boolean))];
        const colorContainer = document.getElementById('colorOptionsContainer');
        if (colors.length > 0) {
            colorContainer.innerHTML = `
                <label class="form-label text-muted small text-uppercase fw-bold">Cor</label>
                <div class="d-flex gap-2 flex-wrap">
                    ${colors.map(color => {
                const variant = allVariants.find(v => v.cor === color);
                const hex = variant ? (variant.cor_hex || colorMap[color.toLowerCase()] || '#CCCCCC') : '#CCCCCC';
                const isWhite = hex.toUpperCase() === '#FFFFFF';
                return `
                        <div class="position-relative">
                            <input type="radio" class="btn-check" name="colorOption" id="color_${color}" value="${color}" autocomplete="off" onchange="handleColorChange('${color}')">
                            <label class="btn rounded-circle p-0 d-flex align-items-center justify-content-center shadow-sm" 
                                   for="color_${color}" 
                                   style="width: 40px; height: 40px; background-color: ${hex}; border: 2px solid ${isWhite ? '#ccc' : hex}; cursor: pointer;"
                                   title="${color}">
                                   <i class="fas fa-check text-${isWhite ? 'dark' : 'white'} opacity-0 check-icon"></i>
                            </label>
                        </div>
                    `}).join('')}
                </div>
                <style>
                    .btn-check:checked + label { border-color: #ffc107 !important; transform: scale(1.1); }
                    .btn-check:checked + label .check-icon { opacity: 1 !important; }
                </style>
            `;
            if (colors.length > 0) {
                document.getElementById(`color_${colors[0]}`).checked = true;
                handleColorChange(colors[0]);
            }
        } else {
            colorContainer.innerHTML = '';
            selectedColor = null;
            updateSizeOptions();
        }
    }

    function handleColorChange(color) {
        selectedColor = color;
        updateSizeOptions();
        const variant = allVariants.find(v => v.cor === color);
        if (variant) renderProductInfo(variant);
    }

    function updateSizeOptions() {
        const availableVariants = selectedColor ? allVariants.filter(v => v.cor === selectedColor) : allVariants;
        const sizes = [...new Set(availableVariants.map(v => v.tamanho).filter(Boolean))];
        const sizeContainer = document.getElementById('sizeButtons');

        if (sizes.length > 0) {
            sizeContainer.innerHTML = sizes.map(size => `
                <input type="radio" class="btn-check" name="sizeOption" id="size_${size}" value="${size}" autocomplete="off" onchange="handleSizeChange('${size}')">
                <label class="btn btn-outline-dark px-3 py-2" for="size_${size}">${size}</label>
            `).join('');
            selectedSize = null;
        } else {
            sizeContainer.innerHTML = '<span class="text-muted small">Tamanho único / Indisponível</span>';
            selectedSize = null;
        }
    }

    function handleSizeChange(size) {
        selectedSize = size;
        const variant = findSelectedVariant();
        if (variant) renderProductInfo(variant);
    }

    function findSelectedVariant() {
        return allVariants.find(v => (!selectedColor || v.cor === selectedColor) && (!selectedSize || v.tamanho === selectedSize));
    }

    function adjustQty(delta) {
        const input = document.getElementById('productQty');
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        const variant = findSelectedVariant();
        if (variant && val > variant.quantidade) {
            val = variant.quantidade;
            Swal.fire({ icon: 'warning', title: 'Estoque Limitado', text: `Apenas ${variant.quantidade} unidades disponíveis.`, toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
        }
        input.value = val;
    }

    function addToCartCurrent() {
        const variant = findSelectedVariant();
        if (allVariants.some(v => v.cor) && !selectedColor) {
            Swal.fire({ icon: 'info', title: 'Selecione uma cor', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }
        if (allVariants.some(v => v.tamanho) && !selectedSize) {
            Swal.fire({ icon: 'info', title: 'Selecione um tamanho', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }
        if (!variant && allVariants.length > 1) {
            Swal.fire({ icon: 'error', title: 'Produto indisponível', text: 'Combinação não encontrada.', toast: true, position: 'top-end', background: '#1e1e1e', color: '#fff' });
            return;
        }

        const finalProduct = variant || currentProduct;
        const qty = parseInt(document.getElementById('productQty').value);
        let cart = JSON.parse(localStorage.getItem('fp_fitness_cart')) || [];
        const existingItem = cart.find(item => item.id === finalProduct.id && item.color === (finalProduct.cor || null) && item.size === (finalProduct.tamanho || null));

        if (existingItem) {
            existingItem.quantity += qty;
        } else {
            cart.push({
                id: finalProduct.id, quantity: qty, size: finalProduct.tamanho || null, color: finalProduct.cor || null,
                nome: finalProduct.nome, price: finalProduct.preco_venda, image: finalProduct.imagem_url
            });
        }
        localStorage.setItem('fp_fitness_cart', JSON.stringify(cart));
        updateCartCount();
        Swal.fire({ icon: 'success', title: 'Adicionado!', text: `${qty}x ${finalProduct.nome} adicionado ao carrinho.`, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, background: '#1e1e1e', color: '#fff' });
    }

    // --- REVIEWS LOGIC ---

    async function loadReviews() {
        try {
            const res = await fetch(`/api/store/products/${productId}/reviews`);
            const reviews = await res.json();
            const container = document.getElementById('reviewsContainer');
            const ratingSummary = document.getElementById('ratingSummaryContainer');
            const ratingStars = document.getElementById('ratingStars');
            const ratingCount = document.getElementById('ratingCount');

            if (reviews.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-4 text-muted"><p>Seja o primeiro a avaliar este produto!</p></div>';
                ratingSummary.style.setProperty('display', 'none', 'important');
                return;
            }

            // Calculate Average
            const totalStars = reviews.reduce((acc, r) => acc + r.nota, 0);
            const avg = totalStars / reviews.length;

            // Render Stars Summary
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= Math.round(avg)) starsHtml += '<i class="fas fa-star"></i>';
                else starsHtml += '<i class="far fa-star"></i>';
            }
            ratingStars.innerHTML = starsHtml;
            ratingCount.textContent = `(${avg.toFixed(1)} de ${reviews.length} avaliações)`;
            ratingSummary.style.setProperty('display', 'flex', 'important');

            // Render Reviews
            container.innerHTML = reviews.map(r => `
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold mb-0">${r.cliente_nome}</h6>
                                <small class="text-muted">${r.data_criacao}</small>
                            </div>
                            <div class="text-warning mb-2">
                                ${Array(r.nota).fill('<i class="fas fa-star"></i>').join('')}
                                ${Array(5 - r.nota).fill('<i class="far fa-star"></i>').join('')}
                            </div>
                            <p class="card-text text-muted">${r.comentario || ''}</p>
                            ${r.midias.length > 0 ? `
                                <div class="d-flex gap-2 mt-2 overflow-auto">
                                    ${r.midias.map(m => m.tipo === 'foto'
                ? `<img src="/frontend/uploads/reviews/${m.url}" class="review-media-preview" onclick="window.open(this.src)">`
                : `<video src="/frontend/uploads/reviews/${m.url}" class="review-media-preview" controls></video>`
            ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error('Erro ao carregar avaliações:', error);
        }
    }

    async function checkReviewEligibility() {
        if (!token) return;
        try {
            const res = await fetch(`/api/store/products/${productId}/can_review`, {
                headers: { 'x-client-token': token }
            });
            const data = await res.json();
            if (data.can_review) {
                document.getElementById('writeReviewBtn').style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao verificar elegibilidade:', error);
        }
    }

    function openReviewModal() {
        new bootstrap.Modal(document.getElementById('reviewModal')).show();
    }

    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        const nota = document.querySelector('input[name="nota"]:checked')?.value;
        const comentario = document.getElementById('reviewComment').value;
        const files = document.getElementById('reviewMedia').files;

        if (!nota) {
            Swal.fire({ icon: 'warning', title: 'Nota obrigatória', text: 'Por favor, selecione uma nota de 1 a 5.' });
            return;
        }

        formData.append('nota', nota);
        formData.append('comentario', comentario);
        for (let i = 0; i < files.length; i++) {
            formData.append('midia', files[i]);
        }

        try {
            const res = await fetch(`/api/store/products/${productId}/reviews`, {
                method: 'POST',
                headers: { 'x-client-token': token },
                body: formData
            });
            const result = await res.json();

            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                Swal.fire({ icon: 'success', title: 'Sucesso!', text: 'Sua avaliação foi enviada.' });
                loadReviews();
                document.getElementById('writeReviewBtn').style.display = 'none'; // Hide button after review
            } else {
                Swal.fire({ icon: 'error', title: 'Erro', text: result.erro || 'Erro ao enviar avaliação.' });
            }
        } catch (error) {
            console.error(error);
            Swal.fire({ icon: 'error', title: 'Erro', text: 'Erro de conexão.' });
        }
    });
</script>
{% endblock %}